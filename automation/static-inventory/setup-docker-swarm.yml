---

  # Initialize Swarm on Manager node and get the join-token.
  - name: Init Swarm Manager
    hosts: manager
    gather_facts: False
    remote_user: ubuntu
    become: true
    become_method: sudo
    tasks:
      - name: Swarm Init
        command: docker swarm init --advertise-addr {{ inventory_hostname }}

      - name: Get Worker Token
        command: docker swarm join-token worker -q
        register: worker_token

      - name: Show Worker Token
        debug: var=worker_token.stdout

      - name: Manager Token
        command: docker swarm join-token manager -q
        register: manager_token

      - name: Show Manager Token
        debug: var=manager_token.stdout

  # Attach worker nodes using the join-token retrieved from manager node
  - name: Join Swarm Cluster
    hosts: workers
    remote_user: ubuntu
    gather_facts: False
    become: true
    become_method: sudo
    vars:
      token: "{{ hostvars[groups['manager'][0]]['worker_token']['stdout'] }}"
      manager: "{{ hostvars[groups['manager'][0]]['inventory_hostname'] }}"
    tasks:
      - name: Join Swarm Cluster as a Worker
        command: docker swarm join --token {{ token }} {{ manager }}:2377
        register: worker

      - name: Show Results
        debug: var=worker.stdout

      - name: Show Errors
        debug: var=worker.stderr